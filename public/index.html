<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç™¾ç»œå›¾åºŠ</title>
    <!-- Fluent UI Components -->
    <script type="module" src="https://unpkg.com/@fluentui/web-components"></script>
    <link rel="stylesheet" href="/index.css">
    <style>
        /* é’ˆå¯¹å›¾åºŠçš„ç‰¹å®šè¡¥å……æ ·å¼ */
        body {
            /* ç¡®ä¿æ‹–æ‹½å…¨å±ç”Ÿæ•ˆ */
            min-height: 100vh;
        }
        
        /* æ‹–æ‹½æ—¶çš„å…¨å±é®ç½© */
        #drag-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2em;
            color: #0078d4;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        
        #drag-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .upload-area {
            border: 2px dashed rgba(0,0,0,0.2);
            border-radius: 8px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: rgba(255,255,255,0.4);
        }

        .upload-area:hover {
            border-color: #0078d4;
            background: rgba(255,255,255,0.6);
        }

        /* æ–‡ä»¶åˆ—è¡¨æ ·å¼ */
        .file-list {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .file-item {
            display: flex;
            align-items: center;
            background: rgba(255,255,255,0.6);
            padding: 10px;
            border-radius: 6px;
            border: 1px solid rgba(0,0,0,0.05);
            animation: fadeIn 0.3s ease;
        }

        .file-preview {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 4px;
            margin-right: 15px;
            background: #eee;
        }

        .file-info {
            flex: 1;
            overflow: hidden;
        }

        .file-name {
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .file-meta {
            font-size: 0.85em;
            color: #666;
            margin-top: 4px;
        }

        .file-link {
            font-size: 0.85em;
            color: #0078d4;
            margin-top: 4px;
            display: block;
            word-break: break-all;
            cursor: pointer;
        }

        .file-action {
            margin-left: 10px;
        }
        
        .upload-actions {
            margin-top: 20px; 
            text-align: center; 
            display: none; /* é»˜è®¤éšè—ï¼Œæœ‰æ–‡ä»¶æ—¶æ˜¾ç¤º */
        }
        
        .upload-actions.show {
            display: block;
        }

        /* å¤åˆ¶æˆåŠŸæ°”æ³¡æ ·å¼ */
        .copy-bubble {
            position: fixed;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none;
            z-index: 10000;
            animation: floatUp 0.8s ease-out forwards;
            white-space: nowrap;
        }

        @keyframes floatUp {
            0% { opacity: 1; transform: translate(-50%, -100%); }
            100% { opacity: 0; transform: translate(-50%, -250%); }
        }
    </style>
</head>
<body>
    <!-- æ‹–æ‹½é®ç½© -->
    <div id="drag-overlay">é‡Šæ”¾ä»¥æ·»åŠ å›¾ç‰‡</div>

    <!-- é¡¶æ  -->
    <nav class="navbar">
        <div style="display: flex; align-items: center; max-width: 1200px; width: 100%; margin: 0 auto;">
            <img src="/img/1769871391490/98a7056e04cb259c73f38b3f44591575" alt="Logo" style="height: 30px; margin-right: 10px;"> <!-- å‡è®¾ä½ æœ‰ä¸€ä¸ª logo -->
            <h1 style="font-size: 18px; margin: 0; font-weight: 600;">ç™¾ç»œå›¾åºŠ</h1>
            <div style="margin-left: auto;">
                <a href="/api/doc" class="btn">API æ–‡æ¡£</a>
                <a href="/" class="btn">é¦–é¡µ</a>
            </div>
        </div>
    </nav>

    <!-- ä¸»è¦å†…å®¹åŒº -->
    <div class="main-content" style="margin-top: 80px; display: flex; justify-content: center;">
        <div class="user-info-card" style="max-width: 600px; width: 100%; margin: 0;">
            <div class="post-title">ä¸Šä¼ å›¾ç‰‡</div>
            <div class="post-content">
                <!-- ç‚¹å‡»ä¸Šä¼ åŒºåŸŸ -->
                <div class="upload-area" id="click-upload">
                    <fluent-icon style="font-size: 32px; color: #0078d4;">â˜ï¸</fluent-icon>
                    <p style="margin: 10px 0 0 0; font-weight: 600;">ç‚¹å‡»é€‰æ‹©æˆ–æ‹–æ‹½å›¾ç‰‡è‡³é¡µé¢ä»»æ„ä½ç½®</p>
                    <p style="margin: 5px 0 0 0; font-size: 12px; color: #666;">æ”¯æŒ JPG, PNG, GIF, WEBP</p>
                </div>
                
                <!-- éšè—çš„æ–‡ä»¶è¾“å…¥æ¡† -->
                <input type="file" id="file-input" multiple accept="image/*" style="display: none;">

                <!-- æ–‡ä»¶åˆ—è¡¨ -->
                <div class="file-list" id="file-list">
                    <!-- JS åŠ¨æ€ç”Ÿæˆ -->
                </div>

                <!-- ä¸Šä¼ æŒ‰é’® -->
                <div class="upload-actions" id="upload-btn-container">
                    <button class="pushButton primary" style="width: 100%;" onclick="startUpload()">å¼€å§‹ä¸Šä¼ </button>
                </div>
            </div>
        </div>
    </div>

    <!-- è„šæœ¬é€»è¾‘ -->
    <script>
        const fileInput = document.getElementById('file-input');
        const clickUpload = document.getElementById('click-upload');
        const fileListEl = document.getElementById('file-list');
        const dragOverlay = document.getElementById('drag-overlay');
        const uploadBtnContainer = document.getElementById('upload-btn-container');

        let pendingFiles = []; // å­˜å‚¨å¾…ä¸Šä¼ çš„æ–‡ä»¶å¯¹è±¡ {id, file, status, url}

        // 1. å…¨å±€æ‹–æ‹½äº‹ä»¶
        let dragCounter = 0;

        window.addEventListener('dragenter', (e) => {
            e.preventDefault();
            dragCounter++;
            dragOverlay.classList.add('active');
        });

        window.addEventListener('dragleave', (e) => {
            e.preventDefault();
            dragCounter--;
            if (dragCounter === 0) {
                dragOverlay.classList.remove('active');
            }
        });

        window.addEventListener('dragover', (e) => e.preventDefault());

        window.addEventListener('drop', (e) => {
            e.preventDefault();
            dragCounter = 0;
            dragOverlay.classList.remove('active');
            
            const files = e.dataTransfer.files;
            handleFiles(files);
        });

        // 2. ç‚¹å‡»ä¸Šä¼ 
        clickUpload.addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
            fileInput.value = ''; // é‡ç½®ä»¥ä¾¿é‡å¤é€‰æ‹©
        });

        // 3. å¤„ç†æ–‡ä»¶æ·»åŠ 
        function handleFiles(files) {
            Array.from(files).forEach(file => {
                if (!file.type.startsWith('image/')) {
                    alert('ä»…æ”¯æŒå›¾ç‰‡æ–‡ä»¶: ' + file.name);
                    return;
                }
                
                const id = Date.now() + Math.random().toString(36).substr(2, 9);
                const fileObj = {
                    id,
                    file,
                    status: 'pending', // pending, uploading, success, error
                    url: null
                };
                
                pendingFiles.push(fileObj);
                renderFileItem(fileObj);
            });
            updateUI();
        }

        // 4. æ¸²æŸ“å•ä¸ªæ–‡ä»¶é¡¹
        function renderFileItem(item) {
            const div = document.createElement('div');
            div.className = 'file-item';
            div.id = `item-${item.id}`;
            
            // ç”Ÿæˆé¢„è§ˆå›¾
            const reader = new FileReader();
            reader.onload = (e) => {
                div.querySelector('.file-preview').src = e.target.result;
            };
            reader.readAsDataURL(item.file);

            // æ ¼å¼åŒ–å¤§å°
            const size = (item.file.size / 1024).toFixed(2) + ' KB';

            div.innerHTML = `
                <img class="file-preview" src="">
                <div class="file-info">
                    <div class="file-name" title="${item.file.name}">${item.file.name}</div>
                    <div class="file-meta">${size}</div>
                    <div class="file-link" id="link-${item.id}" style="display:none;"></div>
                    <div id="progress-${item.id}" style="height: 4px; background: #eee; margin-top: 5px; border-radius: 2px; display:none;">
                        <div style="height: 100%; background: #0078d4; width: 0%; transition: width 0.3s;"></div>
                    </div>
                </div>
                <div class="file-action">
                    <button class="pushButton secondary" onclick="removeFile('${item.id}')" style="padding: 4px 10px;">ğŸ—‘ï¸</button>
                </div>
            `;
            
            fileListEl.appendChild(div);
        }

        // 5. ç§»é™¤æ–‡ä»¶
        window.removeFile = function(id) {
            pendingFiles = pendingFiles.filter(f => f.id !== id);
            const el = document.getElementById(`item-${id}`);
            if (el) el.remove();
            updateUI();
        }

        function updateUI() {
            // å¦‚æœæœ‰å¾…ä¸Šä¼ çš„æ–‡ä»¶ï¼Œæ˜¾ç¤ºä¸Šä¼ æŒ‰é’®
            const hasPending = pendingFiles.some(f => f.status === 'pending');
            if (hasPending) {
                uploadBtnContainer.classList.add('show');
            } else {
                uploadBtnContainer.classList.remove('show');
            }
        }

        // 6. æ‰§è¡Œä¸Šä¼ 
        window.startUpload = async function() {
            const btn = uploadBtnContainer.querySelector('button');
            btn.disabled = true;
            btn.textContent = 'ä¸Šä¼ ä¸­...';

            for (let item of pendingFiles) {
                if (item.status !== 'pending') continue;

                item.status = 'uploading';
                const itemEl = document.getElementById(`item-${item.id}`);
                const progressBar = document.getElementById(`progress-${item.id}`);
                const progressInner = progressBar.querySelector('div');
                const linkEl = document.getElementById(`link-${item.id}`);
                const deleteBtn = itemEl.querySelector('.file-action button'); // ä¸Šä¼ åéšè—åˆ é™¤ï¼Œæˆ–è€…ä¿ç•™çœ‹éœ€æ±‚

                progressBar.style.display = 'block';
                progressInner.style.width = '50%'; // æ¨¡æ‹Ÿè¿›åº¦ï¼Œå› ä¸º fetch æ²¡æœ‰åŸç”Ÿè¿›åº¦å›è°ƒ

                const formData = new FormData();
                formData.append('image', item.file);

                try {
                    const response = await fetch('/api/upload', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        item.status = 'success';
                        item.url = result.data.url;
                        
                        progressInner.style.width = '100%';
                        setTimeout(() => { progressBar.style.display = 'none'; }, 500);
                        
                        linkEl.style.display = 'block';
                        const fullUrl = window.location.origin + result.data.url;
                        // é“¾æ¥æ–‡å­—ç‚¹å‡»ä¹Ÿæ”¹ä¸ºä½¿ç”¨æ°”æ³¡æç¤º
                        linkEl.innerHTML = `ğŸ”— <span onclick="copyLink('${fullUrl}', event)" title="ç‚¹å‡»å¤åˆ¶" style="cursor:pointer;">${fullUrl}</span>`;
                        
                        // æˆåŠŸåç§»é™¤â€œåˆ é™¤â€æŒ‰é’®ï¼Œæ”¹ä¸ºâ€œå¤åˆ¶â€æŒ‰é’®
                        const actionDiv = itemEl.querySelector('.file-action');
                        actionDiv.innerHTML = `<button class="pushButton secondary" onclick="copyLink('${fullUrl}', event)" title="å¤åˆ¶é“¾æ¥" style="padding: 4px 10px;">ğŸ“‹</button>`;
                        
                    } else {
                        item.status = 'error';
                        progressBar.style.display = 'none';
                        linkEl.style.display = 'block';
                        linkEl.style.color = 'red';
                        linkEl.textContent = 'ä¸Šä¼ å¤±è´¥: ' + result.message;
                    }

                } catch (error) {
                    console.error(error);
                    item.status = 'error';
                    progressBar.style.display = 'none';
                    linkEl.style.display = 'block';
                    linkEl.style.color = 'red';
                    linkEl.textContent = 'ç½‘ç»œé”™è¯¯';
                }
            }
            
            btn.disabled = false;
            btn.textContent = 'å¼€å§‹ä¸Šä¼ ';
            updateUI(); // é‡æ–°æ£€æŸ¥æ˜¯å¦è¿˜æœ‰ pending
        }

        // 7. å¤åˆ¶é“¾æ¥å¹¶æ˜¾ç¤ºæ°”æ³¡
        window.copyLink = function(url, event) {
            navigator.clipboard.writeText(url).then(() => {
                showBubble(event.clientX, event.clientY, 'å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            }).catch(err => {
                showBubble(event.clientX, event.clientY, 'å¤åˆ¶å¤±è´¥');
            });
        }

        // 8. æ˜¾ç¤ºä¸Šæµ®æ°”æ³¡
        function showBubble(x, y, message) {
            const bubble = document.createElement('div');
            bubble.className = 'copy-bubble';
            bubble.textContent = message;
            
            // è®¾ç½®ä½ç½®
            bubble.style.left = x + 'px';
            bubble.style.top = y + 'px';
            
            document.body.appendChild(bubble);

            // åŠ¨ç”»ç»“æŸåç§»é™¤å…ƒç´  (0.8s ä¸ CSS åŠ¨ç”»æ—¶é—´ä¸€è‡´)
            setTimeout(() => {
                bubble.remove();
            }, 800);
        }
    </script>
</body>
</html>